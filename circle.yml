machine:
  node:
    version: 6.9.1
test:
  pre:
    - NODE_ENV=test make client/config/index.js:
        parallel: true
    - ? |
          case $CIRCLE_NODE_INDEX in
            0) NODE_ENV=test make build-server;
               ;;

            1) I18N_DIR=$CIRCLE_ARTIFACTS/translate;
               mkdir -p $I18N_DIR;
               make translate;
               mv calypso-strings.pot $I18N_DIR/calypso-strings.pot;
               if [[ $CIRCLE_BRANCH != "master" ]]; then
                 git merge-base --fork-point master | xargs git checkout;
                 make translate;
                 mv calypso-strings.pot $I18N_DIR/calypso-strings-master.pot;
                 cp $I18N_DIR/calypso-strings-master.pot $I18N_DIR/calypso-strings-master-copy.pot;
                 msgcat -u $I18N_DIR/calypso-strings*.pot > $I18N_DIR/localci-new-strings.pot;
                 rm $I18N_DIR/calypso-strings-master-copy.pot;
                 git checkout $CIRCLE_SHA1;
               fi;
               ;;
          esac;
      : parallel: true
  override:
    - bin/run-lint :
        parallel: true
        files:
          - client/**/*.js
          - client/**/*.jsx
          - server/**/*.js
          - server/**/*.jsx
    - MOCHA_FILE=./test-results-client.xml npm run test-client -- -R mocha-junit-reporter -t $CIRCLE_NODE_TOTAL -i $CIRCLE_NODE_INDEX:
        parallel: true
    - MOCHA_FILE=./test-results-server.xml npm run test-server -- -R mocha-junit-reporter -t $CIRCLE_NODE_TOTAL -i $CIRCLE_NODE_INDEX:
        parallel: true
    - MOCHA_FILE=./test-results-test.xml npm run test-test -- -R mocha-junit-reporter -t $CIRCLE_NODE_TOTAL -i $CIRCLE_NODE_INDEX:
        parallel: true
  post:
    - mkdir -p $CIRCLE_TEST_REPORTS/junit/ && find . -type f -regex  "./test-results.*\.xml" -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;:
        parallel: true
notify:
  webhooks:
    - url: https://translate.wordpress.com/api/localci/-relay-new-strings-to-gh
